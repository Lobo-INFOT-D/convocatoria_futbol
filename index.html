<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alineaci√≥n F√∫tbol Sala</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    body { background:#f7f7f9; }

    /* ===== LISTA JUGADORES ===== */
    .jugador-row {
      display:flex; align-items:center; justify-content:space-between;
      padding:.5rem; border-bottom:1px solid #ddd;
    }
    .jugador-nombre { flex:1; font-weight:500; }
    .jugador-row .btn { margin:2px; padding:6px 10px; }

    /* ===== CAMPO ===== */
    .campo {
      position:relative; width:100%; max-width:1000px;
      aspect-ratio:2.2/1; margin:1rem auto;
      background:#4caf50; border:4px solid #fff;
      border-radius:8px; overflow:hidden;
    }
    .linea-central { position:absolute; inset:0 auto 0 50%; width:2px; background:#fff; }
    .area, .porteria { position:absolute; border:2px solid #fff; }
    .area { width:20%; height:40%; top:30%; }
    .area.izq { left:0; } .area.der { right:0; }
    .porteria { width:4%; height:20%; top:40%; background:rgba(255,255,255,.2); }
    .porteria.izq { left:-4%; } .porteria.der { right:-4%; }

    /* Jugadores en el campo */
    .jugador-campo {
      position:absolute; width:80px; height:80px;
      border-radius:50%; font-weight:bold; font-size:.8rem;
      display:flex; align-items:center; justify-content:center;
      text-align:center; padding:4px;
    }
    .equipoA { background:#fff; border:2px solid #000; color:#000; }
    .equipoB { background:#f44336; color:#fff; }

    /* POSICIONES (NO TOCADAS) */
    #porteroA { left:5%; top:45%; }
    #defensaA1 { left:18%; top:25%; }
    #defensaA2 { left:18%; top:65%; }
    #alaA { left:32%; top:35%; }
    #extraA { left:32%; top:55%; }

    #porteroB { right:5%; top:45%; }
    #defensaB1 { right:18%; top:25%; }
    #defensaB2 { right:18%; top:65%; }
    #alaB { right:32%; top:35%; }
    #pivotB { right:42%; top:50%; }

    /* M√≥viles */
    @media (max-width:768px) {
  .jugador-row { 
    flex-direction: column; 
    align-items: flex-start; 
  }
  .jugador-campo { 
    width: 60px;   /* Antes 80px */
    height: 60px;  /* Antes 80px */
    font-size: 0.7rem; 
  }
  .jugador-campo button { 
    font-size: 0.6rem; 
  }
}
</style>
</head>
<body>
<div class="container py-4">

  <h1 class="h3 text-center">Convocatoria intuitiva</h1>
  <p class="text-center text-muted">Asignaci√≥n ¬∑ Campo ¬∑ Reservas ¬∑ Imagen</p>

  <!-- ===== LISTA ===== -->
  <div class="card mb-4">
    <div class="card-body">
      <h2 class="h5">Lista de jugadores</h2>
      <div id="listaJugadores"></div>

      <div class="input-group mt-3">
        <input id="inputNombre" class="form-control" placeholder="A√±adir jugador">
        <button id="btnAddJugador" class="btn btn-primary">A√±adir</button>
      </div>
    </div>
  </div>

  <!-- ===== CAMPO ===== -->
  <div id="contenedorCampo">
    <div class="campo">
      <div class="linea-central"></div>
      <div class="area izq"></div>
      <div class="area der"></div>
      <div class="porteria izq"></div>
      <div class="porteria der"></div>

      <!-- Equipo A -->
      <div id="porteroA" class="jugador-campo equipoA">Portero A</div>
      <div id="defensaA1" class="jugador-campo equipoA">Def A1</div>
      <div id="defensaA2" class="jugador-campo equipoA">Def A2</div>
      <div id="alaA" class="jugador-campo equipoA">Ala A</div>
      <div id="extraA" class="jugador-campo equipoA">Extra A</div>

      <!-- Equipo B -->
      <div id="porteroB" class="jugador-campo equipoB">Portero B</div>
      <div id="defensaB1" class="jugador-campo equipoB">Def B1</div>
      <div id="defensaB2" class="jugador-campo equipoB">Def B2</div>
      <div id="alaB" class="jugador-campo equipoB">Ala B</div>
      <div id="pivotB" class="jugador-campo equipoB">P√≠vot B</div>
    </div>
  </div>

  <!-- ===== RESERVAS ===== -->
  <div class="card mt-4">
    <div class="card-body">
      <h2 class="h5">Reservas</h2>
      <ul id="listaReservas" class="list-group"></ul>
    </div>
  </div>

  <!-- ===== BOTONES ===== -->
  <div class="mt-3 text-center">
    <button class="btn btn-success me-2" onclick="exportarImagen()">üì∏ Exportar imagen</button>
    <button class="btn btn-info" onclick="copiarLista()">üìã Copiar lista</button>
  </div>
</div>

<!-- Firebase SDK -->
<script type="module">

  /* ================================
      IMPORTS FIREBASE (CORREGIDO)
  ==================================*/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
  import { 
    getFirestore, collection, addDoc, deleteDoc, doc, getDocs 
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  /* ================================
          CONFIG FIREBASE
  ==================================*/
  const firebaseConfig = {
    apiKey: "AIzaSyDA_FDkrsAxtBt5_BhRgRkq3NNq3Lt7xdo",
    authDomain: "convocatoria-8c340.firebaseapp.com",
    projectId: "convocatoria-8c340",
    storageBucket: "convocatoria-8c340.firebasestorage.app",
    messagingSenderId: "968350738606",
    appId: "1:968350738606:web:bdff77002fe19077a7a53f",
    measurementId: "G-ZV9MG4T1FF"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const db = getFirestore(app);

  /* ================================
             VARIABLES
  ==================================*/
  const posicionesA = ["porteroA","defensaA1","defensaA2","alaA","extraA"];
  const posicionesB = ["porteroB","defensaB1","defensaB2","alaB","pivotB"];
  let ocupadasA = 0, ocupadasB = 0;
  let jugadoresBD = [];

  const inputNombre = document.getElementById("inputNombre");
  const btnAddJugador = document.getElementById("btnAddJugador");

  /* ================================
            CARGAR JUGADORES
  ==================================*/
  async function cargarJugadores() {
    try {
      const querySnapshot = await getDocs(collection(db, "jugadores"));
      jugadoresBD = querySnapshot.docs.map(d => ({
        id: d.id,
        nombre: d.data().nombre
      }));
      renderLista();
    } catch (err) {
      console.error("Error cargando jugadores:", err);
    }
  }

  async function addJugador(nombre) {
    await addDoc(collection(db, "jugadores"), { nombre });
    cargarJugadores();
  }

  async function removeJugador(id) {
    await deleteDoc(doc(db, "jugadores", id));
    cargarJugadores();
  }

  window.removeJugador = removeJugador; // Hacer accesible globalmente

  /* ================================
              RENDER LISTA
  ==================================*/
  function renderLista() {
    const cont = document.getElementById("listaJugadores");
    cont.innerHTML = "";

    jugadoresBD.forEach(jugador => {
      const div = document.createElement("div");
      div.className = "jugador-row";

      div.innerHTML = `
        <div class="jugador-nombre">${jugador.nombre}</div>

        <div class="btn-group">
          <input type="radio" class="btn-check" name="rol-${jugador.id}" id="tit-${jugador.id}" value="titular">
          <label class="btn btn-outline-success" for="tit-${jugador.id}">Titular</label>

          <input type="radio" class="btn-check" name="rol-${jugador.id}" id="res-${jugador.id}" value="reserva">
          <label class="btn btn-outline-secondary" for="res-${jugador.id}">Reserva</label>
        </div>

        <div class="btn-group">
          <input type="radio" class="btn-check" name="equipo-${jugador.id}" id="eqA-${jugador.id}" value="A">
          <label class="btn btn-outline-dark" for="eqA-${jugador.id}">‚ö™ Blanco</label>

          <input type="radio" class="btn-check" name="equipo-${jugador.id}" id="eqB-${jugador.id}" value="B">
          <label class="btn btn-outline-danger" for="eqB-${jugador.id}">üî¥ Rojo</label>
        </div>

        <button class="btn btn-warning btn-sm" onclick="removeJugador('${jugador.id}')">‚ùå</button>
        <button class="btn btn-secondary btn-sm" onclick="resetJugador('${jugador.id}','${jugador.nombre}')">üîÑ</button>


      `;

      // Eventos
      div.querySelectorAll("input").forEach(inp => {
        inp.addEventListener("change", () => actualizarCampo(jugador));
      });

      cont.appendChild(div);
    });
  }

  /* ================================
          A√ëADIR JUGADOR
  ==================================*/
  btnAddJugador.onclick = () => {
    const nom = inputNombre.value.trim();
    if (!nom) return;
    addJugador(nom);
    inputNombre.value = "";
  };

  /* ================================
            ACTUALIZAR CAMPO
     (MISMA L√ìGICA QUE TEN√çAS)
  ==================================*/
  function actualizarCampo(jugador) {
    const nom = jugador.nombre;
    const rol = document.querySelector(`input[name="rol-${jugador.id}"]:checked`);
    const eq  = document.querySelector(`input[name="equipo-${jugador.id}"]:checked`);
    if(!rol) return;

    quitarDeReservas(nom);
    quitarDelCampo(nom);

    if(rol.value==="titular" && eq){
      const arr = eq.value==="A" ? posicionesA : posicionesB;
      const occ = eq.value==="A" ? ocupadasA : ocupadasB;

      if(occ < arr.length){
        const pos = arr[occ];
        document.getElementById(pos).innerHTML = nom;
        if(eq.value==="A") ocupadasA++; else ocupadasB++;
      } 
      else alert("Ya hay 5 titulares en este equipo");
    } 
    else if(rol.value==="reserva") {
      const li=document.createElement("li");
      li.className="list-group-item d-flex justify-content-between";
      li.innerHTML=`${nom}<button class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">‚ùå</button>`;
      listaReservas.appendChild(li);
    }
  }

  function quitarDeReservas(nom){
    document.querySelectorAll("#listaReservas li").forEach(li=>{
      if(li.textContent.includes(nom)) li.remove();
    });
  }

  function quitarDelCampo(nom){
    [...posicionesA, ...posicionesB].forEach(pos=>{
      const el=document.getElementById(pos);
      if(el.textContent.includes(nom)){
        el.textContent = pos;
        if(pos.includes("A")) ocupadasA--; else ocupadasB--;
      }
    });
  }

  /* ================================
         EXPORTAR IMAGEN
  ==================================*/
  window.exportarImagen = function(){
    html2canvas(document.getElementById("contenedorCampo")).then(canvas=>{
      const link=document.createElement("a");
      link.download="alineacion.jpg";
      link.href=canvas.toDataURL("image/jpeg",0.9);
      link.click();
    });
  }

  /* ================================
            COPIAR LISTA
  ==================================*/
  window.copiarLista = function(){
    let titularesA=[], titularesB=[], reservas=[];

    posicionesA.forEach(pos=>{
      const t=document.getElementById(pos).textContent;
      if(!t.includes(pos)) titularesA.push(t + " ‚ö™");
    });
    posicionesB.forEach(pos=>{
      const t=document.getElementById(pos).textContent;
      if(!t.includes(pos)) titularesB.push(t + " üî¥");
    });

    document.querySelectorAll("#listaReservas li").forEach(li=>{
      reservas.push(li.textContent.replace("‚ùå","").trim());
    });

    navigator.clipboard.writeText(
      "Titulares Equipo A:\n"+titularesA.join("\n")+"\n\n"+
      "Titulares Equipo B:\n"+titularesB.join("\n")+"\n\n"+
      "Reservas:\n"+reservas.join("\n")
    );
  };
    /* ================================
            RESET JUGADOR*/
function resetJugador(id, nombre) {
    // Quitar selecci√≥n de ROL
    document.querySelectorAll(`input[name="rol-${id}"]`).forEach(r => r.checked = false);

    // Quitar selecci√≥n de EQUIPO
    document.querySelectorAll(`input[name="equipo-${id}"]`).forEach(r => r.checked = false);

    // Sacarlo del campo si estaba colocado
    quitarDelCampo(nombre);

    // Quitar reservas si estaba como reserva
    quitarDeReservas(nombre);
}

window.resetJugador = resetJugador; // Hacer accesible globalmente
  /* ================================
                 INICIO
  ==================================*/
  cargarJugadores();

</script>
</body>
</html>