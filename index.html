<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alineaci√≥n F√∫tbol Sala ‚Äî Optimizado (Opci√≥n A)</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    body { background:#f7f7f9; font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }

    /* ===== LISTA JUGADORES ===== */
    .jugador-row {
      display:flex; align-items:center; justify-content:space-between;
      padding:.5rem; border-bottom:1px solid #e9ecef;
      gap:.5rem;
    }
    .jugador-nombre { flex:1; font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .jugador-row .btn { margin:0 2px; padding:6px 10px; }

    /* ===== CAMPO ===== */
    .campo {
      position:relative; width:100%; max-width:1000px;
      aspect-ratio:2.2/1; margin:1rem auto;
      background:#2b05b4; border:4px solid #0b5130;
      border-radius:10px; overflow:hidden;
      box-shadow: 0 6px 18px rgba(10,10,10,0.08);
    }
    .linea-central { position:absolute; inset:0 auto 0 50%; width:2px; background:rgba(255,255,255,0.5); transform:translateX(-50%); }
    .area, .porteria { position:absolute; border:2px solid rgba(255,255,255,0.25); }
    .area { width:20%; height:40%; top:30%; border-radius:6px; background: rgba(255,255,255,0.02); }
    .area.izq { left:0; } .area.der { right:0; }
    .porteria { width:4%; height:20%; top:40%; background:rgba(0,0,0,0.08); border-radius:4px; }
    .porteria.izq { left:-4%; } .porteria.der { right:-4%; }

    /* Jugadores en el campo */
    .jugador-campo {
      position: absolute;
      min-width: 48px;
      padding: 6px 10px;
      border-radius: 8px;
      font-weight: 700;
      font-size: .95rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: #fff;
      background: rgba(0,0,0,0.25);
      white-space: nowrap;
      transform: translate(-50%, -50%);
      z-index: 10;
      transition: transform .18s ease, opacity .18s ease;
      opacity: .98;
      box-shadow: 0 3px 8px rgba(0,0,0,0.12);
    }
    .jugador-campo.asignado { transform: translate(-50%,-50%) scale(1.06); }

    .equipoA { color:#ffffff; background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(0,0,0,0.06)); }
    .equipoB { color:rgb(28, 43, 26); background: linear-gradient(180deg, rgba(255, 0, 0, 0.8), rgba(231, 229, 229, 0.993)); }

    /* POSICIONES (NO TOCAR IDs) */
    #porteroA { left:8%; top:45%; }
    #defensaA1 { left:18%; top:25%; }
    #defensaA2 { left:18%; top:75%; }
    #alaA { left:32%; top:35%; }
    #extraA { left:32%; top:55%; }

    #porteroB { right: 1px; top:47%; }
    #defensaB1 { right:18%; top:25%; }
    #defensaB2 { right:18%; top:65%; }
    #alaB { right:32%; top:35%; }
    #pivotB { right:32%; top:55%; }

    /* BOTONES EQUIPO */
    .btn-equipoA { border:1px solid #ccc; background:#ffffff; color:#111; }
    .btn-equipoB { border:1px solid #222; background:#111; color:#fff; }

    /* Reservas list */
    #listaReservas .list-group-item { display:flex; justify-content:space-between; align-items:center; gap:.5rem; }

    /* M√≥viles */
    @media (max-width:768px) {
      .jugador-row { 
        flex-direction: column; 
        align-items: stretch;
      }
      .campo { aspect-ratio:1.6/1; max-width:768px; }
      .jugador-campo { 
        min-width: 36px; padding:4px 6px; font-size:0.75rem;
      }
      .jugador-campo { white-space:nowrap; max-width: 80px; overflow:hidden; text-overflow:ellipsis; }
    }

    /* small niceties */
    .small-muted { font-size:0.85rem; color:#6c757d; }
  </style>
</head>
<body>
<div class="container py-4">

  <div class="container py-4 text-center">
  <h1 class="h3 mb-3">Convocatoria Futbito</h1>
  <p class="text-muted mb-4">Mi√©rcoles de futbito !!</p>

  <!-- Bot√≥n con estilo Bootstrap -->
  <a href="resultado.html" class="btn btn-success btn-lg mb-4">
    Ir a Resultados
  </a>
</div>

  <!-- ===== FECHA ===== -->
  <div class="mt-3 mb-4 text-center">
    <label for="fechaInput" class="form-label">üìÖ Fecha del partido</label>
    <input type="date" id="fechaInput" class="form-control mx-auto" style="max-width:250px;">
  </div>

  <!-- ===== LISTA ===== -->
  <div class="card mb-4">
    <div class="card-body">
      <h2 class="h5">Lista de jugadores</h2>
      <div id="listaJugadores"></div>

      <div class="input-group mt-3">
        <input id="inputNombre" class="form-control" placeholder="A√±adir jugador (Enter para a√±adir)">
        <button id="btnAddJugador" class="btn btn-primary">A√±adir</button>
      </div>
      <div class="mt-2 small text-muted">Marca <strong>Titular</strong> o <strong>Reserva</strong>, luego elige equipo. Titular requiere equipo.</div>
    </div>
  </div>

  <!-- ===== CAMPO ===== -->
  <div id="contenedorCampo">
    <div class="campo" id="campo">
      <div class="linea-central"></div>
      <div class="area izq"></div>
      <div class="area der"></div>
      <div class="porteria izq"></div>
      <div class="porteria der"></div>

      <!-- Equipo A -->
      <div id="porteroA" class="jugador-campo equipoA" data-placeholder="Portero A">Portero A</div>
      <div id="defensaA1" class="jugador-campo equipoA" data-placeholder="Def A1">Def A1</div>
      <div id="defensaA2" class="jugador-campo equipoA" data-placeholder="Def A2">Def A2</div>
      <div id="alaA" class="jugador-campo equipoA" data-placeholder="Ala A">Ala A</div>
      <div id="extraA" class="jugador-campo equipoA" data-placeholder="pivot A">pivot A</div>

      <!-- Equipo B -->
      <div id="porteroB" class="jugador-campo equipoB" data-placeholder="Portero B">Portero B</div>
      <div id="defensaB1" class="jugador-campo equipoB" data-placeholder="Def B1">Def B1</div>
      <div id="defensaB2" class="jugador-campo equipoB" data-placeholder="Def B2">Def B2</div>
      <div id="alaB" class="jugador-campo equipoB" data-placeholder="Ala B">Ala B</div>
      <div id="pivotB" class="jugador-campo equipoB" data-placeholder="P√≠vot B">P√≠vot B</div>
    </div>
  </div>

  <!-- ===== RESERVAS ===== -->
  <div class="card mt-4">
    <div class="card-body">
      <h2 class="h5">Reservas</h2>
      <ul id="listaReservas" class="list-group"></ul>
    </div>
  </div>

  <!-- ===== BOTONES ===== -->
  <div class="card shadow-sm">
    <div class="card-body text-center">
      <h5 class="card-title mb-3">Acciones</h5>

      <div class="d-flex flex-wrap justify-content-center gap-2">
        <button class="btn btn-success flex-fill" id="btnExport">üì∏ Exportar imagen</button>
        <button class="btn btn-info flex-fill" id="btnCopiar">üìã Copiar lista</button>
        <button class="btn btn-primary flex-fill" id="btnAlineacion">üíæ Guardar alineaci√≥n</button>
      </div>


    </div>
  </div>
</div>

<!-- Firebase SDK & App (module) -->
<script type="module">
  // ---------- FIREBASE IMPORTS ----------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
  import { 
    getFirestore, collection, addDoc, deleteDoc, doc, getDocs, setDoc 
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  // ---------- CONFIG FIREBASE (mant√©n la tuya) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyDA_FDkrsAxtBt5_BhRgRkq3NNq3Lt7xdo",
    authDomain: "convocatoria-8c340.firebaseapp.com",
    projectId: "convocatoria-8c340",
    storageBucket: "convocatoria-8c340.firebasestorage.app",
    messagingSenderId: "968350738606",
    appId: "1:968350738606:web:bdff77002fe19077a7a53f",
    measurementId: "G-ZV9MG4T1FF"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const db = getFirestore(app);

  // ---------- ESTADO / CONSTANTES ----------
  const posiciones = {
    A: ["porteroA","defensaA1","defensaA2","alaA","extraA"],
    B: ["porteroB","defensaB1","defensaB2","alaB","pivotB"]
  };
  let ocupadasA = 0, ocupadasB = 0;
  let jugadoresBD = []; // { id, nombre }

  /* Elementos DOM */
  const inputNombre = document.getElementById("inputNombre");
  const btnAddJugador = document.getElementById("btnAddJugador");
  const listaJugadoresCont = document.getElementById("listaJugadores");
  const listaReservas = document.getElementById("listaReservas");
  const contCampo = document.getElementById("campo");
  const btnExport = document.getElementById("btnExport");
  const btnCopiar = document.getElementById("btnCopiar");

  // ---------- UTILIDADES ----------
  const getRolChecked = (id) => document.querySelector(`input[name="rol-${id}"]:checked`);
  const getEquipoChecked = (id) => document.querySelector(`input[name="equipo-${id}"]:checked`);

  function placeholderOf(el) {
    return el.dataset.placeholder ?? el.id;
  }

  function estaEnReservas(nombre) {
    return [...listaReservas.children].some(li => li.dataset.nombre === nombre);
  }

  // recalcula ocupadas desde DOM (robusto)
  function recalcularOcupadas() {
    ocupadasA = posiciones.A.reduce((acc, pos) => {
      const el = document.getElementById(pos);
      return acc + (el && el.textContent.trim() !== placeholderOf(el) ? 1 : 0);
    }, 0);
    ocupadasB = posiciones.B.reduce((acc, pos) => {
      const el = document.getElementById(pos);
      return acc + (el && el.textContent.trim() !== placeholderOf(el) ? 1 : 0);
    }, 0);
  }

  // Busca la primera posicion vac√≠a para equipo (A o B). Devuelve id o null
  function primeraPosicionLibre(equipo) {
    for (const pos of posiciones[equipo]) {
      const el = document.getElementById(pos);
      if (el && el.textContent.trim() === placeholderOf(el)) return pos;
    }
    return null;
  }

  // Quitar a un jugador del campo (por nombre)
  function quitarDelCampo(nombre) {
    [...posiciones.A, ...posiciones.B].forEach(pos => {
      const el = document.getElementById(pos);
      if (!el) return;
      if (el.textContent.trim() === nombre) {
        el.textContent = placeholderOf(el);
        // optional: remove assigned visual class
        el.classList.remove("asignado");
      }
    });
    recalcularOcupadas();
  }

  // Quitar de reservas
  function quitarDeReservas(nombre) {
    [...listaReservas.children].forEach(li => {
      if (li.dataset.nombre === nombre) li.remove();
    });
  }

  // Evita a√±adir reserva duplicada
  function addReservaSiNoExiste(nombre) {
    if (estaEnReservas(nombre)) return;
    const li = document.createElement("li");
    li.className = "list-group-item";
    li.dataset.nombre = nombre;
    li.innerHTML = `
      <span class="flex-grow-1">${nombre}</span>
      <div>
        <button class="btn btn-sm btn-outline-danger" title="Quitar reserva">‚ùå</button>
      </div>
    `;
    li.querySelector("button").onclick = () => li.remove();
    listaReservas.appendChild(li);
  }

// Quitar jugador de cualquier parte de la alineaci√≥n
function quitarJugadorDeAlineacion(nombre) {
  alineacion.titularesA = alineacion.titularesA.filter(t => t.nombre !== nombre);
  alineacion.titularesB = alineacion.titularesB.filter(t => t.nombre !== nombre);
  alineacion.reservas = alineacion.reservas.filter(r => r !== nombre);
}


  // ---------- FIRESTORE: CARGAR INICIAL ----------
  async function cargarJugadores() {
    try {
      const snapshot = await getDocs(collection(db, "jugadores"));
      jugadoresBD = snapshot.docs.map(d => ({ id: d.id, nombre: d.data().nombre }));
      renderLista();
    } catch (err) {
      console.error("Error cargando jugadores:", err);
      // en caso de fallo, lista queda vac√≠a y el resto sigue funcionando
      jugadoresBD = [];
      renderLista();
    }
  }

  // ---------- FIRESTORE: A√ëADIR / BORRAR optimizados ----------
  async function addJugador(nombre) {
    // trim y protecci√≥n
    nombre = nombre.trim();
    if (!nombre) return;

    // prevenir duplicados en la lista local
    if (jugadoresBD.some(j => j.nombre.toLowerCase() === nombre.toLowerCase())) {
      alert("Ese jugador ya est√° en la lista.");
      return;
    }

    try {
      const docRef = await addDoc(collection(db, "jugadores"), { nombre });
      // Actualizar estado local sin recargar desde Firestore
      jugadoresBD.push({ id: docRef.id, nombre });
      renderLista();
    } catch (err) {
      console.error("Error a√±adiendo jugador:", err);
      alert("No se pudo a√±adir el jugador. Mira la consola.");
    }
  }

 async function removeJugador(id) {
  if (!confirm("¬øEliminar jugador de la base de datos?")) return;

  const jugador = jugadoresBD.find(j => j.id === id);
  if (!jugador) return;

  try {
    await deleteDoc(doc(db, "jugadores", id));
    // limpiar campo y reservas antes de actualizar lista
    quitarDelCampo(jugador.nombre);
    quitarDeReservas(jugador.nombre);

    jugadoresBD = jugadoresBD.filter(j => j.id !== id);
    renderLista();
    recalcularOcupadas();
  } catch (err) {
    console.error("Error borrando jugador:", err);
    alert("No se pudo eliminar. Revisa la consola.");
  }
}


  // Exponer globalmente para onclick inline (bot√≥n delete)
  window.removeJugador = removeJugador;

  // ---------- RENDER LISTA ----------
  function renderLista() {
  const cont = document.getElementById("listaJugadores");
  cont.innerHTML = "";

  jugadoresBD.forEach(jugador => {
    const div = document.createElement("div");
    div.className = "jugador-row";

    div.innerHTML = `
      <div class="jugador-nombre">${jugador.nombre}</div>

      <div class="btn-group">
        <input type="radio" class="btn-check rol" name="rol-${jugador.id}" id="tit-${jugador.id}" value="titular">
        <label class="btn btn-outline-success" for="tit-${jugador.id}">Titular</label>

        <input type="radio" class="btn-check rol" name="rol-${jugador.id}" id="res-${jugador.id}" value="reserva">
        <label class="btn btn-outline-secondary" for="res-${jugador.id}">Reserva</label>
      </div>

      <div class="btn-group equipos">
        <input type="radio" class="btn-check" name="equipo-${jugador.id}" id="eqA-${jugador.id}" value="A" disabled>
        <label class="btn btn-outline-dark equipo-label" for="eqA-${jugador.id}">‚ö™ Blanco</label>

        <input type="radio" class="btn-check" name="equipo-${jugador.id}" id="eqB-${jugador.id}" value="B" disabled>
        <label class="btn btn-outline-dark equipo-label" for="eqB-${jugador.id}">‚ö´ Negro</label>
      </div>

      <button class="btn btn-warning btn-sm" onclick="removeJugador('${jugador.id}')">‚ùå</button>
      <button class="btn btn-secondary btn-sm" onclick="resetJugador('${jugador.id}','${jugador.nombre}')">üîÑ</button>
    `;

    const radioTit = div.querySelector(`#tit-${jugador.id}`);
    const radioRes = div.querySelector(`#res-${jugador.id}`);
    const eqA = div.querySelector(`#eqA-${jugador.id}`);
    const eqB = div.querySelector(`#eqB-${jugador.id}`);
    const labelA = div.querySelector(`label[for="eqA-${jugador.id}"]`);
    const labelB = div.querySelector(`label[for="eqB-${jugador.id}"]`);

    function actualizarEquipos() {
      if (radioTit.checked) {
        eqA.disabled = false;
        eqB.disabled = false;
        labelA.classList.remove("disabled");
        labelB.classList.remove("disabled");
      } else {
        eqA.disabled = true;
        eqB.disabled = true;
        eqA.checked = false;
        eqB.checked = false;
        labelA.classList.add("disabled");
        labelB.classList.add("disabled");
      }
    }

    radioTit.addEventListener("change", actualizarEquipos);
    radioRes.addEventListener("change", actualizarEquipos);

    div.querySelectorAll("input").forEach(inp => {
      inp.addEventListener("change", () => actualizarCampo(jugador));
    });

    cont.appendChild(div);
  });
}

  // ---------- L√ìGICA ACTUALIZAR CAMPO ----------
  // ---------- L√ìGICA ACTUALIZAR CAMPO ----------
function actualizarCampo(jugador) {
  const rol = getRolChecked(jugador.id);
  const equipo = getEquipoChecked(jugador.id);

  if (!rol) return;

  // Siempre limpiamos cualquier rastro previo
  quitarDeReservas(jugador.nombre);
  quitarDelCampo(jugador.nombre);

  if (rol.value === "titular") {
    if (!equipo) return; // Esperamos elecci√≥n de equipo

    const equipoId = equipo.value;
    recalcularOcupadas();

    if ((equipoId === "A" && ocupadasA >= posiciones.A.length) ||
        (equipoId === "B" && ocupadasB >= posiciones.B.length)) {
      alert("Ya hay 5 titulares en ese equipo.");
      return;
    }

    const posLibre = primeraPosicionLibre(equipoId);
    if (!posLibre) return;

    const el = document.getElementById(posLibre);
    el.textContent = jugador.nombre;
    el.classList.add("asignado");
    setTimeout(() => el.classList.remove("asignado"), 350);

    recalcularOcupadas();

  } else if (rol.value === "reserva") {
    addReservaSiNoExiste(jugador.nombre);
  }
}

// ---------- RESET JUGADOR (fuera de actualizarCampo) ----------
function resetJugador(id, nombre) {
  document.querySelectorAll(`input[name="rol-${id}"]`).forEach(r => r.checked = false);
  document.querySelectorAll(`input[name="equipo-${id}"]`).forEach(r => r.checked = false);
  quitarDelCampo(nombre);
  quitarDeReservas(nombre);
  recalcularOcupadas();
}
window.resetJugador = resetJugador;


  // ---------- COPIAR LISTA (mejorada) ----------
  function copiarLista() {
    let titularesA = [], titularesB = [], reservas = [];

    posiciones.A.forEach(pos => {
      const el = document.getElementById(pos);
      if (el && el.textContent.trim() !== placeholderOf(el)) titularesA.push(el.textContent.trim() + " ‚ö™");
    });
    posiciones.B.forEach(pos => {
      const el = document.getElementById(pos);
      if (el && el.textContent.trim() !== placeholderOf(el)) titularesB.push(el.textContent.trim() + " ‚ö´");
    });

    [...listaReservas.children].forEach(li => reservas.push(li.dataset.nombre));

    const texto =
      "Titulares Equipo A:\n" + (titularesA.length ? titularesA.join("\n") : "‚Äî") +
      "\n\nTitulares Equipo B:\n" + (titularesB.length ? titularesB.join("\n") : "‚Äî") +
      "\n\nReservas:\n" + (reservas.length ? reservas.join("\n") : "‚Äî");

    navigator.clipboard.writeText(texto).then(() => {
      alert("Lista copiada al portapapeles.");
    }).catch(() => {
      alert("No se pudo copiar autom√°ticamente. Selecciona y copia manualmente.");
    });
  }
  window.copiarLista = copiarLista;
  // ---------- GUARDAR ALINEACI√ìN ----------
async function guardarAlineacion() {
  let titularesA = [], titularesB = [], reservas = [];
  const fecha = document.getElementById("fechaInput").value;

  // Recoger titulares del equipo A
  posiciones.A.forEach(pos => {
    const el = document.getElementById(pos);
    if (el && el.textContent.trim() !== placeholderOf(el))
      titularesA.push(el.textContent.trim());
  });

  // Recoger titulares del equipo B
  posiciones.B.forEach(pos => {
    const el = document.getElementById(pos);
    if (el && el.textContent.trim() !== placeholderOf(el))
      titularesB.push(el.textContent.trim());
  });

  // Recoger reservas
  [...listaReservas.children].forEach(li => reservas.push(li.dataset.nombre));

  // Texto para copiar al portapapeles
  const texto =
    "üìÖ *Fecha:* " + (fecha || "‚Äî") +
    "\n\n‚ö™ *Equipo A (Blancos)*\n" + (titularesA.length ? "‚Ä¢ " + titularesA.join("\n‚Ä¢ ") : "‚Äî") +
    "\n\n‚ö´ *Equipo B (Negros)*\n" + (titularesB.length ? "‚Ä¢ " + titularesB.join("\n‚Ä¢ ") : "‚Äî") +
    "\n\nüîÅ *Reservas*\n" + (reservas.length ? "‚Ä¢ " + reservas.join("\n‚Ä¢ ") : "‚Äî");

  navigator.clipboard.writeText(texto);

  // Guardar en Firebase con fecha como ID
  try {
    const docRefe = doc(db, "alineaciones", fecha);

    // ‚úÖ setDoc sobrescribe si ya existe el mismo ID (fecha)
    await setDoc(docRefe, {
      TitularesA: titularesA,
      TitularesB: titularesB,
      reservas: reservas,
      fecha: fecha,
      resultado: null
    });

    alert("‚úÖ Alineaci√≥n guardada en Firebase (√∫nica por fecha, sobrescrita si ya exist√≠a).");
  } catch (e) {
    console.error("Error al guardar en Firebase: ", e);
    alert("‚ùå No se pudo guardar en Firebase.");
  }
}

window.guardarAlineacion = guardarAlineacion;



  // ---------- EXPORTAR IMAGEN (m√°s n√≠tida) ----------
  function exportarImagen() {
    html2canvas(document.getElementById("contenedorCampo"), { scale: 2 }).then(canvas => {
      const link = document.createElement("a");
      link.download = "alineacion.jpg";
      link.href = canvas.toDataURL("image/jpeg", 0.95);
      link.click();
    }).catch(err => {
      console.error("Error exportando imagen:", err);
      alert("No se pudo exportar la imagen.");
    });
  }

  // ---------- EVENTOS UI ----------
  btnAddJugador.addEventListener("click", () => {
    addJugador(inputNombre.value);
    inputNombre.value = "";
    inputNombre.focus();
  });

  inputNombre.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      addJugador(inputNombre.value);
      inputNombre.value = "";
    }
  });

  btnExport.addEventListener("click", exportarImagen);
  btnCopiar.addEventListener("click", copiarLista);
  btnAlineacion.addEventListener("click", guardarAlineacion);


  // ---------- INICIALIZACI√ìN ----------
  // Inicializamos placeholders en el campo (por si el HTML se modifica)
  function inicializarPlaceholders() {
    [...posiciones.A, ...posiciones.B].forEach(pos => {
      const el = document.getElementById(pos);
      if (el && (!el.dataset.placeholder || el.dataset.placeholder.trim() === "")) {
        el.dataset.placeholder = pos;
      }
      // Si el contenido es vac√≠o, ponemos placeholder visible
      if (el && (!el.textContent || el.textContent.trim() === "")) {
        el.textContent = placeholderOf(el);
      }
    });
    recalcularOcupadas();
  }

  inicializarPlaceholders();
  cargarJugadores();

</script>
</body>
</html>